#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include "rp.h" // red pitaya API

// defines buffer size, provided by red pitaya
#define BUFF_SIZE 16384

int main(int argc, char **argv) {

    // buffers to allocate data
    float *adc_buf = (float *)malloc(BUFF_SIZE * sizeof(float));
    float *dac_buf = (float *)malloc(BUFF_SIZE * sizeof(float));
    
    // red pitaya API initializes
    rp_Init();

    printf("Program initialized.\n");

    // acquisition configuration (IN)
    rp_AcqReset(); 
    rp_AcqSetDecimation(RP_DEC_1);
    rp_AcqSetTriggerDelay(0);

    // signal generator configuration (OUT)
    rp_GenReset();
    rp_GenWaveform(RP_CH_1, RP_WAVEFORM_SINE);
    rp_GenAmp(RP_CH_1, 1.0);
    rp_GenFreq(RP_CH_1, 7630.0);
    rp_GenOutEnable(RP_CH_1);

    // begins loop
    while (1) {

        // data acquisition
        rp_AcqStart();
        rp_AcqSetTriggerSrc(RP_TRIG_SRC_CHA_PE); // data acquisition is triggered at rising edge
        rp_acq_trig_state_t state = RP_TRIG_STATE_TRIGGERED;

        // program waits for trigger
        while (1) {
            rp_AcqGetTriggerState(&state);
            if (state == RP_TRIG_STATE_TRIGGERED) {
                break;
            }
        }

        // stores acquired data in adc_buf
        uint32_t buf_size = BUFF_SIZE;
        rp_AcqGetOldestDataV(RP_CH_1, &buf_size, adc_buf);

        // modifies amplification
        for (int i = 0; i < BUFF_SIZE; i++) {
            dac_buf[i] = adc_buf[i] * 2.0; // 2.0 set to default double amplification factor
        }

        // data generation
        rp_GenArbWaveform(RP_CH_1, dac_buf, BUFF_SIZE); // loads dac_buff into output
        rp_GenTrigger(RP_CH_1); // trigers output
    }

    // program cleanup (disables output, releases API, frees memory)
    rp_GenOutDisable(RP_CH_1);
    rp_Release();
    free(adc_buf);
    free(dac_buf);

    printf("Program complete.\n");

    return 0;
}
